(window.webpackJsonp=window.webpackJsonp||[]).push([[176],{636:function(s,a,n){"use strict";n.r(a);var e=n(3),t=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"location-匹配顺序"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#location-匹配顺序"}},[s._v("#")]),s._v(" location 匹配顺序")]),s._v(" "),a("p",[s._v("location模块分类有3类： 精确、正则和非正则。")]),s._v(" "),a("p",[s._v("=：精确匹配：必须和pattern完全相同才会匹配成功；匹配成功后会直接返回，不会继续匹配。")]),s._v(" "),a("p",[s._v("对于正则location，如果当前模块匹配成功，则直接返回成功，不会向下继续匹配。（顺序很重要，匹配到第一个就返回）")]),s._v(" "),a("ul",[a("li",[s._v("~*：不区分大小写正则；")]),s._v(" "),a("li",[s._v("~：区分大小写正则；")]),s._v(" "),a("li",[s._v("^~：非正则，或者理解为前缀匹配。和普通前缀匹配区别是匹配pattern成功后会立即返回。")])]),s._v(" "),a("p",[s._v("对于非正则location，需要等所有其他模块匹配完成后，然后从成功匹配的模块中选取最长匹配前缀返回。（顺序无所谓，最终按照最长的返回）")]),s._v(" "),a("ul",[a("li",[s._v("''：普通（前缀）匹配：当前缀和pattern匹配时，匹配成功；")]),s._v(" "),a("li",[s._v("/：通用匹配：如果没有其他匹配，则匹配当前请求；（可以理解为优先级最低的前缀匹配）")])]),s._v(" "),a("p",[s._v("匹配流程为：")]),s._v(" "),a("ol",[a("li",[s._v("先判断精确匹配是否命中，命中则直接返回。")]),s._v(" "),a("li",[s._v("从上往下依次匹配，普通匹配命中，进行记录。正则匹配命中，直接返回。")]),s._v(" "),a("li",[s._v("匹配顺序遍历完成后，没有正则命中，依据普通匹配命中pattern最长的模块进行返回。")])]),s._v(" "),a("h2",{attrs:{id:"location-配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#location-配置"}},[s._v("#")]),s._v(" location 配置")]),s._v(" "),a("h3",{attrs:{id:"静态资源配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#静态资源配置"}},[s._v("#")]),s._v(" 静态资源配置")]),s._v(" "),a("p",[a("span",{staticClass:"red"},[s._v("对于nginx静态资源的路径配置，必须使用绝对路径。 （nginx默认的index.html资源路径可能是做了映射，因此使用相对路径，但我们进行配置时必须使用绝对路径。）")])]),s._v(" "),a("p",[s._v("静态资源的路径配置包括 root 和 alias。")]),s._v(" "),a("p",[a("span",{staticClass:"red"},[s._v("root命令指定的必须是目录。（末尾加不加斜杠都无所谓）。结果为：root + uri")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    server_name  www.xxx.com;\n    \n    # 对于所有以 .html 结尾的请求，都将替换为到 /home/king/**.html 目录下搜索文件。\n    # eg： 对于请求uri /page/static/index.html，转换后的结果为： /home/king/page/static/index.html\n    location ~ \\.html$ {\n        root  /home/king;\n        index index.html;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[a("span",{staticClass:"red"},[s._v("alias命令必须指定目录，并且目录末尾的斜杠必须和pattern中的斜杠同时出现，或者同时不写。结果为：uri后面未匹配到pattern的部分 + alias")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    server_name  www.xxx.com;\n    \n    # 对于请求 /img/static/a.jpg  重定向最终结果为去 /home/king/static/a.jpg 目录中查找文件\n    location ~ /img/ {\n        alias  /home/king/;\n        index index.html;\n    }\n    \n    # 同上\n    location ~ /img {\n        alias  /home/king;\n        index index.html;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("h3",{attrs:{id:"反向代理配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#反向代理配置"}},[s._v("#")]),s._v(" 反向代理配置")]),s._v(" "),a("p",[s._v("反向代理配置需要注意 proxy_pass 后面是否带有 / 。")]),s._v(" "),a("ul",[a("li",[s._v("如果有 / ： 则返回结果为：proxy_pass  + 将uri中未匹配到的（pattern）部分。")]),s._v(" "),a("li",[s._v("如果没有 / ： 则返回结果为： proxy_pass + uri。")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    server_name  www.xxx.com;\n    \n    # 对于请求 http://www.xxx.com/order/api/v1/makeorder, 最终转发到上游服务器的url为： http:127.0.0.1:8080/order/api/v1/makeorder。\n    location ^~ /order/ {\n        proxy_pass http:127.0.0.1:8080;\n    }\n    \n    # 对于请求 http://www.xxx.com/order/api/v1/makeorder, 最终转发到上游服务器的url为： http:127.0.0.1:8080/api/v1/makeorder。\n    location ^~ /order/ {\n        proxy_pass http:127.0.0.1:8080/;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("h3",{attrs:{id:"重定向配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#重定向配置"}},[s._v("#")]),s._v(" 重定向配置")]),s._v(" "),a("p",[s._v("由于网站迁移，或者接口地址修改，为了兼容老用户接口访问，我们通常需要对旧的url进行重定向，重定向主要通过 rewrite 指令操作。")]),s._v(" "),a("p",[s._v("rewrite指定：对请求的URI做正则匹配，不包括域名和查询参数，然后进行重定向。")]),s._v(" "),a("p",[s._v("replacement 指定的 regex 对应解析的字符串是 请求的 uri。")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    server_name  www.xxx.com;\n    \n    # 对于请求 http://www.xxx.com/order/api/v1/makeorder, 我们现在服务器和接口都进行了修改，需要将旧地址重定向到新地址上。 \n    # 重定向后的结果为： http://www.yyy.com/order/api/v2/makeorder\n    location /order {\n        rewrite ^/(.*)/v1/(.*)$  http://www.yyy.com/$1/v2/$2 permanent;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("ul",[a("li",[s._v("$request_uri：包含请求参数的原始URI，不包含主机名，如：http://www.abc.com/abc/bbs/index.html?a=1&b=2 中的 /abc/bbs/index.php?a=1&b=2")]),s._v(" "),a("li",[s._v("$uri：这个变量指当前的请求URI，不包括任何参数，如:/abc/bbs/index.html")])]),s._v(" "),a("p",[s._v("扩展：")]),s._v(" "),a("p",[s._v("关于 301 和 302 的区别：")]),s._v(" "),a("ul",[a("li",[s._v("当服务器返回301状态码时，它明确告诉客户端（包括浏览器和搜索引擎爬虫）原始请求的资源已经永久性地移动到了新的URL。收到此状态码的客户端应当更新书签或者将来直接使用新的URL进行访问。搜索引擎在索引时也会将原链接的权重转移到新的URL上，这对SEO（搜索引擎优化）至关重要。")]),s._v(" "),a("li",[s._v("302状态码表示请求的资源已被临时转移到了新的URL上，但这不是一个永久性的变动。客户端应当继续使用原来的URL来执行后续请求，除非另外指示。搜索引擎在遇到302时，通常不会把索引和权重从原URL转移到新URL上，而是保留对原URL的关注。")])]),s._v(" "),a("p",[s._v("临时重定向和永久重定向主要用于告诉搜索引擎，优化搜索算法，提高搜索效率。")]),s._v(" "),a("h2",{attrs:{id:"应用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#应用"}},[s._v("#")]),s._v(" 应用")]),s._v(" "),a("h3",{attrs:{id:"接口临时关闭"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#接口临时关闭"}},[s._v("#")]),s._v(" 接口临时关闭")]),s._v(" "),a("p",[s._v("我们线上发布服务后，可能存在某个接口异常，需要临时关闭，我们可以通过nginx的location模块进行临时拦截返回。")]),s._v(" "),a("p",[s._v("正常线上应用配置：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    server_name  www.xxx.com;\n    \n    # eg: 对于请求http://www.xxx.com/order/api/v1/makeorder, 对于真实后端地址为： http://127.0.0.1:8080/api/v1/makeorder;\n    location ^~ /order/ {\n        proxy_pass  http://127.0.0.1:8080/;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("现在，由于订单接口存在问题，我想临时关闭该接口，我们可以进行如下配置：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    server_name  www.xxx.com;\n    \n    location ^~ /order/api/v1/makeorder {\n        default_type application/json;\n        return 200 \"{'code': 200, 'message': '接口正再加紧修复，请稍后再试！'}\";\n    }\n    \n    # eg: 对于请求http://www.xxx.com/order/api/v1/makeorder, 对于真实后端地址为： http://127.0.0.1:8080/api/v1/makeorder;\n    location ^~ /order/ {\n        proxy_pass  http://127.0.0.1:8080/;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])])])}),[],!1,null,null,null);a.default=t.exports}}]);