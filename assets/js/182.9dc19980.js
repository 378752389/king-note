(window.webpackJsonp=window.webpackJsonp||[]).push([[182],{642:function(s,a,n){"use strict";n.r(a);var t=n(3),e=Object(t.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"rewrite指令"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#rewrite指令"}},[s._v("#")]),s._v(" rewrite指令")]),s._v(" "),a("p",[s._v("定义： 该指令通过正则表达式的使用来改变URI。可以同时存在一个或者多个指令，按照顺序依次对URL进行匹配和处理\n语法： rewrite regex replacement [flag];")]),s._v(" "),a("p",[s._v("flag主要有一下几种选择：")]),s._v(" "),a("ul",[a("li",[s._v("permanent: 永久重定向，返回状态码为301， 浏览器将缓冲重定向响应头中指定的 Location 的 url， 下次请求直接发送到新的 url")]),s._v(" "),a("li",[s._v("redirect: 临时重定向，返回状态码为302，浏览器会跳转到响应头中指定的 Location 的 url， 但不会缓存重定向信息，下次访问任然会再次重定向")]),s._v(" "),a("li",[s._v("break: 将重写后的 uri 作为新的 uri， 继续在当前的 location 模块中执行")]),s._v(" "),a("li",[s._v("last: 将重写后的 uri 作为新的 uri，终止在本 location 中处理，并重写在 server 块中执行")])]),s._v(" "),a("h2",{attrs:{id:"break-和-last"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#break-和-last"}},[s._v("#")]),s._v(" break 和 last")]),s._v(" "),a("p",[s._v("后端服务存在两个接口 "),a("code",[s._v("/")]),s._v(" 和 "),a("code",[s._v("/err")]),s._v(", 其中 "),a("code",[s._v("/")]),s._v(" 返回正常数据， "),a("code",[s._v("/err")]),s._v(" 返回异常数据")]),s._v(" "),a("ul",[a("li",[s._v("使用break配置")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    listen 8084;\n    server_name localhost;\n\n    # 对于所有访问 http://localhost:8084/err 都将代理到  http://localhost:8080/下面：\n    location /err {\n        proxy_pass http://localhost:8080/;\n    }\n\n    # 对于所有 访问 /rw/err* 都将重定向到 /err 路径下\n    location / {\n        rewrite ^/rw/(err).*$ /$1 break;\n        proxy_pass http://localhost:8080;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("现在开始访问： http://localhost:8084/rw/errqaz\nflag 为 break：那么将得到如下结果：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{"code":500,"msg":"操作异常","data":null}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("可见，该 location 直接修改请求路径为： http://localhost:8084/err, 然后继续匹配 proxy_pass 配置")]),s._v(" "),a("ul",[a("li",[s._v("将 break 修改为 last，配置如下")])]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    listen 8084;\n    server_name localhost;\n\n    # 对于所有访问 http://localhost:8084/err 都将代理到  http://localhost:8080/下面：\n    location /err {\n        proxy_pass http://localhost:8080/;\n    }\n\n    # 对于所有 访问 /rw/err* 都将重定向到 /err 路径下\n    location / {\n        rewrite ^/rw/(err).*$ /$1 last;\n        proxy_pass http://localhost:8080;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("现在开始访问： http://localhost:8084/rw/errqaz\nflag 为 last：那么将得到如下结果：")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('{"code":200,"msg":"操作成功","data":null}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("可见，该 location 直接修改请求路径为： http://localhost:8084/err, 然后重新进入 server 块开始匹配， 匹配到 第一个\nlocation "),a("code",[s._v("/err")]),s._v(" 然后返回")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("ul",[a("li",[s._v("通过 last 和 break 匹配， 浏览器 Location 地址栏的 url 不会发生改变， 任然是发送请求时的 url")]),s._v(" "),a("li",[s._v("last 和 break 可以类比 tomcat 的转发(forward)，都是在服务端进行的")])])]),a("h2",{attrs:{id:"permanent-和-redirect"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#permanent-和-redirect"}},[s._v("#")]),s._v(" permanent 和 redirect")]),s._v(" "),a("p",[s._v("使用nginx临时重定向redirect配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    listen 8084;\n    server_name localhost;\n\n    location / {\n        rewrite ^/rw/(err).*$ /$1 redirect;\n        proxy_pass http://localhost:8080;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("每次请求都会返回重定向响应，然后跳转到Location， 响应不会被缓存")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/378752389/image-bed/main/king-note/nginx%E4%B8%B4%E6%97%B6%E9%87%8D%E5%AE%9A%E5%90%91%E8%A7%A3%E6%9E%90%E7%BB%93%E6%9E%9C.png",alt:"nginx临时重定向解析结果"}})]),s._v(" "),a("p",[s._v("使用nginx永久重定向permanent配置")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("server {\n    listen 8084;\n    server_name localhost;\n\n    location / {\n        rewrite ^/rw/(err).*$ /$1 permanent;\n        proxy_pass http://localhost:8080;\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("p",[s._v("第一次请求结果：\n"),a("img",{attrs:{src:"https://raw.githubusercontent.com/378752389/image-bed/main/king-note/nginx%E6%B0%B8%E4%B9%85%E9%87%8D%E5%AE%9A%E5%90%91%E7%AC%AC%E4%B8%80%E6%AC%A1%E8%AF%B7%E6%B1%82%E8%A7%A3%E6%9E%90%E7%BB%93%E6%9E%9C.png",alt:"nginx永久重定向第一次请求解析结果"}})]),s._v(" "),a("p",[s._v("第二次请求结果：\n"),a("img",{attrs:{src:"https://raw.githubusercontent.com/378752389/image-bed/main/king-note/nginx%E6%B0%B8%E4%B9%85%E9%87%8D%E5%AE%9A%E5%90%91%E7%AC%AC%E4%BA%8C%E6%AC%A1%E8%AF%B7%E6%B1%82%E8%A7%A3%E6%9E%90%E7%BB%93%E6%9E%9C.png",alt:"nginx永久重定向第二次请求解析结果"}})]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"title"}),a("ul",[a("li",[s._v("通过 permanent 和 redirect 匹配， 浏览器 Location 地址栏的 url 会发生改变，改变内容为重写后的 url")]),s._v(" "),a("li",[s._v("permanent 和 redirect 可以类比 tomcat 的重定向(redirect)，将链接返回给客户端然后重写 请求 url")])])])])}),[],!1,null,null,null);a.default=e.exports}}]);