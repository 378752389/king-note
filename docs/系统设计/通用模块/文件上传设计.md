---
title: 文件上传设计
date: 2024-08-29
categories:
  - 系统设计
tags:
  - 模块设计
---

## 概述

在设计文件上传功能时，可以使用http文件上传，也可以使用三方OSS进行上传，上传功能是一段模版代码，没有难点，主要是文件存储路径需要设计，本人在工作中参与过
一些项目的开发，基本上都脱离不开文件上传功能，对于路径设计，我给出了一些自己的思考；申明此处通常不包含复杂系统设计（eg：多租户系统）

## 上传路径设计

首先对于系统而言，我们需要确认这个是一个什么类型的系统；其次

### 客户端系统

这类系统特点是用户需要经常上传文件，分享文件，比如微信聊天、婚恋交友、小红书等；那么我们设计时可以以用户为中心，设计路径时就可以依据 `/系统标识/用户标识/业务标识/...`；

:::tip
标识：可以明确定位标识内容，可以是一个字符串、主键、uuid等；且定义后一般不允许变动。

- 系统标识：系统名字；字符串；
- 用户标识：用户主键，uuid；
- 业务标识：业务内容；字符串；
:::

示例：
- 发布图片、文件消息，那么路径设计时可以为： `/im/1/message/`
- 发送动态消息，那么路径可以设计为： `/im/1/moment/`
- 用户收藏的图片： `/im/1/picture`


优点：
- 用户发送的内容路径可以快速进行定位和管理；
- 依据用户限制上传数量：比如用户只能收藏30张图片等；

缺点：
- 统计时，消息这块消耗了多大的存储量；

### 业务类型系统

这类系统特点是用户一般不需要或很少需要上传内容，内容通常是网站设计者提供，比如商城系统、外卖系统、点餐系统等 那么我们设计时可以以业务为中心，设计路径就可以依据 `/系统标识/业务标识/...`

示例：
- 点餐系统用餐品图片展示；`/kfc/food/`



:::tip
这类系统在做业务标识路径设计时，我们不应该把路径分的太细致，同时需要注意路径设计后通常不能再进行变更；

举一个例子：
在设计电商系统时，我有一种食品A，属于食物分类，参考业务类型系统路径可以设计为: `/mall/product/food/食品A.jpg`，现在业务需要进行更细致的划分，取消了食物分类，该为 生鲜、零食、干粮、饮品等，
那么我们之后上传路径可以需要修改为：`/mall/product/drink/食品A.png`等，这样细致划分后就会存在一个类别在多个路径中存在，不便于管理，
设计时我们应该尽量依据<span style="color: red;">不变业务类型设计</span>，对于分类后期会进行修改应该不在路径考虑范围之内。
:::

优点：
- 便于所有产品管理和迁移，结构划分明确；
- 可以基于业务统计消耗了多大的存储量；

缺点：
- 单目录内存储量过大


### 日期标识

通常在设计文件路径时，有时我们也会将路径标识作为路径设计的一部分，那么加入日期标识后会有什么优缺点呢？

优点：
- `/im/1/message/20240824/` 和 `/im/1/20240824/message/`, `/kfc/food/20240824/` 和 `/kfc/20240824/food`
  - 对于前者，可以更容易判断出用户在什么日期有上传过哪些消息文件， 缩短了业务范围；如果只有少量业务需要使用日期标识，推荐使用；
  - 对于后者，只要有业务上传操作，都会创建对应路径，扩大了业务范围但同时增加维护成本；如果有大量业务需要使用日期标识，推荐使用；


缺点：
- 添加了日期标识意味着消息路径会滚动向前，增加了维护成本；



## 文件名重命名映射（修改文件名）

我们需要思考，上传的文件是否需要重命名；文件重命名本身是为了解决文件覆盖的问题；对于相同路径下同一个文件名，后上传的文件会覆盖之前已经上传的文件，导致之前上传的文件丢失。

是否需要文件重命名，我们需要具体分析：
- 重映射：如果用户对系统不了解，用户使用时通常不会注意文件命名规范，这样可能会导致后上传文件覆盖前面上传文件，前面上传文件内容丢失，此时我们需要启用文件重命名，由后端记录原始文件名称；
- 不重映射：如果是管理员，管理员使用时了解文件命名规范，上传时会避免文件重复，同时上传时如果存在相同文件名，可以给出提示，询问是否覆盖，这样会有利于文件管理。
  - 对于不重映射，上传文件前我们可以先发送一个查询请求确认文件是否存在，存在则发送一个消息盒提示管理员是否进行覆盖，否则直接进行上传。

## 业务流程

```
// 1.判断是否需要添加路径标识
// 2.判断业务标识
// 3.判断是否需要日期滚动标识
// 4.判断是否需要重命名
// 5.判断文件是否存在（文件命名冲突，提示用户是否需要进行覆盖文件）
```


```java
public static String parsePath(String filename, UploadBusinessEnum businessEnum) {
  // 项目名称
  String basePath = "/project";

  String path = businessEnum.getPath();

  // 是否需要添加用户标识前缀
  if (isUserBaseSystem()) {
    String userIdentify = getUserIdentify();
    basePath = String.join("/", basePath, userIdentify);
  }

  if (!StrUtil.isEmpty(path)) {
    basePath = String.join("/", basePath, path);
  }

  if (businessEnum.isRollDate()){
    SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMdd");
    String datePath = sdf.format(new Date());
    basePath = String.join("/", basePath, datePath);
  }

  String name = filename;
  if (businessEnum.isRename()) {
    int index = filename.lastIndexOf(".");
    String suffix = filename.substring(index + 1);
    String prefix = UUID.randomUUID().toString().replace("-", "");
    name = String.join(".", prefix, suffix);
  }
  basePath = String.join("/", basePath, name);

  // 判断文件是否存在,给终端操作人员反馈
  boolean fileExist = isFileExist(absPath);
  
  return basePath;

}
```